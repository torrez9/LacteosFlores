name: Code Analysis

on:
  push:
    branches: [ "Workflows" ]
  pull_request:
    branches: [ "Workflows" ]

jobs:
  sast-analysis:
    name: Static Application Security Testing (SAST)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install -q --no-interaction --no-progress --prefer-dist

      # 1ï¸âƒ£ Semgrep (auditorÃ­a de seguridad)
      - name: Run Semgrep Security Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/php
          generateSarif: true
          output: semgrep-results.sarif

      # 2ï¸âƒ£ PHPStan (anÃ¡lisis estÃ¡tico)
      - name: Install PHPStan
        run: composer require --dev phpstan/phpstan

      - name: Run PHPStan Analysis
        run: vendor/bin/phpstan analyse --no-progress --error-format=table || true

      # 3ï¸âƒ£ Evaluar vulnerabilidades crÃ­ticas
      - name: Evaluate critical vulnerabilities
        run: |
          echo "Evaluando vulnerabilidades crÃ­ticas..."
          if grep -qi "CRITICAL" semgrep-results.sarif; then
            echo "âŒ Vulnerabilidades crÃ­ticas detectadas. Pipeline fallarÃ¡."
            exit 1
          else
            echo "âœ… Sin vulnerabilidades crÃ­ticas detectadas."
          fi

      # 4ï¸âƒ£ Guardar artefactos y resumen
      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast-analysis-results
          path: semgrep-results.sarif

      - name: Generate code analysis summary
        run: |
          mkdir -p docs
          REPORT="docs/code-analysis-summary.md"
          echo "# ðŸ” Resumen de AnÃ¡lisis de CÃ³digo" > $REPORT
          echo "Fecha: $(date)" >> $REPORT
          echo "- Herramientas: Semgrep, PHPStan" >> $REPORT
          echo "- Rama: $GITHUB_REF_NAME" >> $REPORT
          echo "" >> $REPORT
          if grep -qi "CRITICAL" semgrep-results.sarif; then
            echo "âŒ Se detectaron vulnerabilidades crÃ­ticas." >> $REPORT
          else
            echo "âœ… Sin vulnerabilidades crÃ­ticas detectadas." >> $REPORT
          fi
          echo "" >> $REPORT
          echo "Resultados detallados disponibles en los artefactos de la acciÃ³n." >> $REPORT

      - name: Commit and Push Summary
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/code-analysis-summary.md
          git commit -m "ðŸ“„ Resumen automÃ¡tico de anÃ¡lisis de cÃ³digo"
          git push origin $GITHUB_REF_NAME || echo "No hay cambios nuevos"
